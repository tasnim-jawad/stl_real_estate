<template>
  <section class="testi-card-area-2 space-top overflow-hidden">
    <div
      class="shape-mockup spin d-none d-xxl-block"
      data-left="7%"
      data-top="14%"
    >
      <img src="assets/frontend/img/shape/hero-3-left-shape.png" alt="img" />
    </div>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-xl-7">
          <div class="title-area text-center">
            <p
              class="sub-title fadeinup wow"
              data-wow-duration="1.5s"
              data-wow-delay="0.1s"
            >
              <span class="double-line"></span>Testimonials
            </p>
            <h2
              class="sec-title fadeinup wow"
              data-wow-duration="1.5s"
              data-wow-delay="0.3s"
            >
              What Clients Say About Pillar
            </h2>
          </div>
        </div>
      </div>
      <div class="row gy-4 justify-content-center">
        <div class="testi-card-slide">
          <div
            class="swiper has-shadow th-slider"
            id="testiSlide1"
            data-slider-options='{"centeredSlides":true,"paginationType": "progressbar","loop":true,"breakpoints":{"0":{"slidesPerView":1},"576":{"slidesPerView":"1"},"768":{"slidesPerView":"1"},"992":{"slidesPerView":"1"},"1200":{"slidesPerView":"1"}}}'
          >
            <div class="swiper-wrapper">
              <div class="swiper-slide">
                <div class="testi-block style-2" dir="ltr">
                  <div class="top-wrap">
                    <div class="quote">
                      <img
                        src="assets/frontend/img/icon/testi-2quote.svg"
                        alt="quote"
                      />
                    </div>
                  </div>
                  <div class="testi-content pe-xl-5 px-xl-5">
                    <p class="box-text">
                      “Adinventitias sequi cerno cedo vapulus adhaero decretum
                      suppono iure voluptate. Trans triumphus toties sed cogito
                      carbo valetudo aequus ciminatio conventus. Voluptates
                      decimus vorago suadeo. Culpo carmen adnuo. Verecundia
                      capio denego. Tracto caterva cavus denique culpa vigor
                      tergum possimus. Aer arceo umerus asperiores templum
                      desidero caritas. Velum adipisci verumtamen comparo
                      ascisco ceno vitiosus aeneus tenetur bibo.”
                    </p>
                  </div>
                  <div class="bottom-wrap">
                    <div class="box-review">
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                    </div>
                    <div class="team-img">
                      <img
                        src="assets/frontend/img/testimonial/testi-2-1.jpg"
                        alt="Team"
                      />
                    </div>
                    <div class="content">
                      <h3 class="box-title">Georgia Schaden</h3>
                      <p class="text">Property owner</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="swiper-slide">
                <div class="testi-block style-2" dir="ltr">
                  <div class="top-wrap">
                    <div class="quote">
                      <img
                        src="assets/frontend/img/icon/testi-2quote.svg"
                        alt="quote"
                      />
                    </div>
                  </div>
                  <div class="testi-content pe-xl-5 px-xl-5">
                    <p class="box-text">
                      “Tenax comitatus ambulo regnum eligo, conturbo vis caelum
                      cohors. Infit ustulo adoptio collum, speciosus lumen
                      soluta. Condico spiculum ratio, sopor conventus adversus
                      fiducia. Arma arcesso altaria impleo pax laboriosus.
                      Tracto caterva cavus denique culpa vigor tergum possimus.
                      Aer arceo umerus asperiores templum desidero caritas.
                      Trepide asporto momentum, Tracto caterva cavus denique
                      culpa vigor. virgo sollemne aurora amo”
                    </p>
                  </div>
                  <div class="bottom-wrap">
                    <div class="box-review">
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                    </div>
                    <div class="team-img">
                      <img
                        src="assets/frontend/img/testimonial/testi-2-2.jpg"
                        alt="Team"
                      />
                    </div>
                    <div class="content">
                      <h3 class="box-title">Walter Deckow</h3>
                      <p class="text">Property owner</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="swiper-slide">
                <div class="testi-block style-2" dir="ltr">
                  <div class="top-wrap">
                    <div class="quote">
                      <img
                        src="assets/frontend/img/icon/testi-2quote.svg"
                        alt="quote"
                      />
                    </div>
                  </div>
                  <div class="testi-content pe-xl-5 px-xl-5">
                    <p class="box-text">
                      “Contendo votum traho clamo statim suffragium numquam
                      teneo. Altus iudicium versor, perpetuus velum pax
                      vestigium carpo. Candidus firmamentum celo, voluptas optio
                      demitto sonitus. Obduro casus adinventio vestigium
                      amplitudo sumo.vestigium carpo. Candidus firmamentum celo,
                      voluptas Concido laboriosam varietas amplector, aureus
                      stella sursum approbo. Gravitas turbo decet, hhe
                      adulescens perpetuus auxilium comes virga.”
                    </p>
                  </div>
                  <div class="bottom-wrap">
                    <div class="box-review">
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                    </div>
                    <div class="team-img">
                      <img
                        src="assets/frontend/img/testimonial/testi-2-1.jpg"
                        alt="Team"
                      />
                    </div>
                    <div class="content">
                      <h3 class="box-title">Carlos Bauch</h3>
                      <p class="text">Property owner</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="swiper-slide">
                <div class="testi-block style-2" dir="ltr">
                  <div class="top-wrap">
                    <div class="quote">
                      <img
                        src="assets/frontend/img/icon/testi-2quote.svg"
                        alt="quote"
                      />
                    </div>
                  </div>
                  <div class="testi-content pe-xl-5 px-xl-5">
                    <p class="box-text">
                      “Tenax comitatus ambulo regnum eligo, conturbo vis caelum
                      cohors. Infit ustulo adoptio collum, speciosus lumen
                      soluta. Condico spiculum ratio, sopor conventus adversus
                      fiducia. Arma arcesso altaria impleo pax laboriosus.
                      Trepide asporto momentum, virgo sollemne aurora amo. Cedo
                      umquam cedo summisse damnum reiciendis veritas flamma.
                      Tempus appono validus translatio, Exemplum adnuo sponte
                      voluntas radius caecus exsisto.”
                    </p>
                  </div>
                  <div class="bottom-wrap">
                    <div class="box-review">
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                      <i class="fa-sharp fa-solid fa-star"></i>
                    </div>
                    <div class="team-img">
                      <img
                        src="assets/frontend/img/testimonial/testi-2-2.jpg"
                        alt="Team"
                      />
                    </div>
                    <div class="content">
                      <h3 class="box-title">Julia Era</h3>
                      <p class="text">Property owner</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="slider-controller container-width">
              <button
                data-slider-prev="#testiSlide1"
                class="slider-arrow default slider-prev"
              >
                <i class="fa fa-arrow-left"></i>
              </button>
              <div
                class="slider-pagination style-2"
                data-slider-id="#testiSlide1"
              ></div>
              <button
                data-slider-next="#testiSlide1"
                class="slider-arrow default slider-next"
              >
                <i class="fa fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="testi-bottom-review-wrap">
            <div class="testi-bottom-item">
              <div class="trust-content">
                <div class="icon">
                  <img src="assets/frontend/img/icon/star-icon.svg" alt="img" />
                </div>
                <h4 class="box-title">Trustipilot</h4>
              </div>
              <div class="bottom">
                <div class="avatar">
                  <img
                    src="assets/frontend/img/hero/heror-1-avator-group.png"
                    alt="img"
                  />
                </div>
                <div class="content">
                  <div class="th-social">
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                  </div>
                  <h4 class="review-title">
                    <span class="number"
                      ><span class="counter-number">19</span>k+</span
                    >
                    clients
                  </h4>
                </div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="testi-bottom-item">
              <div class="trust-content">
                <div class="icon">
                  <img
                    src="assets/frontend/img/icon/google-icon.svg"
                    alt="img"
                  />
                </div>
                <h4 class="box-title">Google</h4>
              </div>
              <div class="bottom">
                <div class="avatar">
                  <img
                    src="assets/frontend/img/hero/heror-1-avator-group-2.png"
                    alt="img"
                  />
                </div>
                <div class="content">
                  <div class="th-social">
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                  </div>
                  <h4 class="review-title">
                    <span class="number"
                      ><span class="counter-number">25</span>k+</span
                    >
                    clients
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>

<script>
import { onMounted, onUpdated, nextTick, ref, onBeforeUnmount } from "vue";

export default {
  setup() {
    const swiperInstance = ref(null);
    const initializationAttempts = ref(0);
    const maxAttempts = 10;

    const initializeTestiSlider = () => {
      const testiSlider = document.querySelector("#testiSlide1");

      // If slider already exists, don't reinitialize
      if (swiperInstance.value) {
        return;
      }

      if (!testiSlider) {
        console.warn("Testimonials slider element not found");
        return;
      }

      if (!window.Swiper) {
        initializationAttempts.value++;
        if (initializationAttempts.value < maxAttempts) {
          // Wait for Swiper to load and try again
          setTimeout(() => initializeTestiSlider(), 200);
        } else {
          console.error("Swiper library not available after multiple attempts");
        }
        return;
      }

      try {
        // Parse data-slider-options if present
        let options = {};
        const optionsAttr = testiSlider.getAttribute("data-slider-options");
        if (optionsAttr) {
          options = JSON.parse(optionsAttr);
        }

        // Normalize string values to proper types
        const normalizeOptions = (obj) => {
          for (const key in obj) {
            if (typeof obj[key] === "string") {
              if (obj[key] === "true") obj[key] = true;
              else if (obj[key] === "false") obj[key] = false;
              else if (!isNaN(obj[key]) && obj[key] !== "")
                obj[key] = Number(obj[key]);
            } else if (typeof obj[key] === "object" && obj[key] !== null) {
              normalizeOptions(obj[key]);
            }
          }
        };
        normalizeOptions(options);

        // Add navigation
        const nextBtn = document.querySelector(
          '[data-slider-next="#testiSlide1"]'
        );
        const prevBtn = document.querySelector(
          '[data-slider-prev="#testiSlide1"]'
        );
        if (nextBtn && prevBtn) {
          options.navigation = {
            nextEl: nextBtn,
            prevEl: prevBtn,
          };
        }

        // Add pagination
        const paginationEl = document.querySelector(
          '[data-slider-id="#testiSlide1"]'
        );
        if (paginationEl) {
          options.pagination = {
            el: paginationEl,
            type: options.paginationType || "progressbar",
          };
        }

        // Initialize slider with merged options
        swiperInstance.value = new window.Swiper(testiSlider, {
          autoplay: {
            delay: 3000,
            disableOnInteraction: false,
          },
          autoHeight: true,
          loop: true,
          spaceBetween: 20,
          ...options,
        });

        console.log("Testimonials slider initialized successfully");
      } catch (error) {
        console.error("Error initializing testimonials slider:", error);
        // Retry on error
        initializationAttempts.value++;
        if (initializationAttempts.value < maxAttempts) {
          setTimeout(() => initializeTestiSlider(), 500);
        }
      }
    };

    const destroySlider = () => {
      if (
        swiperInstance.value &&
        typeof swiperInstance.value.destroy === "function"
      ) {
        swiperInstance.value.destroy(true, true);
        swiperInstance.value = null;
        console.log("Testimonials slider destroyed");
      }
    };

    // Initialize on mount
    onMounted(async () => {
      await nextTick();
      // Multiple initialization attempts with different delays
      setTimeout(() => initializeTestiSlider(), 100);
      setTimeout(() => initializeTestiSlider(), 300);
      setTimeout(() => initializeTestiSlider(), 600);
    });

    // Reinitialize on updates if needed
    onUpdated(async () => {
      await nextTick();
      if (!swiperInstance.value) {
        setTimeout(() => initializeTestiSlider(), 100);
      }
    });

    // Cleanup on unmount
    onBeforeUnmount(() => {
      destroySlider();
    });

    return {
      swiperInstance,
    };
  },
};
</script>

<style lang="scss" scoped></style>
